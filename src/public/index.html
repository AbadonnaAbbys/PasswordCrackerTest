<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Cracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Inter', sans-serif; /* Используем Inter как основной шрифт */
        }
        .container {
            max-width: 900px;
            margin-top: 50px;
            margin-bottom: 50px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px; /* Скругленные углы */
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .card {
            border-radius: 10px; /* Скругленные углы для карточек */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            border-radius: 8px; /* Скругленные углы для кнопок */
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .form-select {
            border-radius: 8px; /* Скругленные углы для селекта */
        }
        .progress-bar {
            border-radius: 5px; /* Скругленные углы для прогресс-бара */
        }
        .list-group-item {
            border-radius: 8px; /* Скругленные углы для элементов списка */
            margin-bottom: 5px;
        }
        .spinner-border {
            width: 1.5rem;
            height: 1.5rem;
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <h1 class="text-center mb-4 text-primary">Password Cracker</h1>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white rounded-top-3">
            <h5 class="mb-0">Запустить новую задачу</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="attackTypeSelect" class="form-label">Выберите тип атаки:</label>
                <select class="form-select" id="attackTypeSelect" v-model="selectedAttackType">
                    <option value="easy_numbers">Easy: 5 чисел (e.g., 12345)</option>
                    <option value="medium_dict">Medium: Словарные слова (max 6 chars)</option>
                    <option value="medium_alpha_num">Medium: 3 заглавные + 1 число (e.g., ABC1)</option>
                    <option value="hard_mixed">Hard: 6 символов (смесь букв/цифр)</option>
                </select>
            </div>
            <button @click="startCrackingJob" :disabled="loading" class="btn btn-primary w-100">
                <span v-if="loading" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                {{ loading ? 'Запуск...' : 'Начать взлом' }}
            </button>
            <div v-if="message" :class="['alert mt-3', messageType === 'success' ? 'alert-success' : 'alert-danger']" role="alert">
                {{ message }}
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white rounded-top-3">
            <h5 class="mb-0">Статус задач</h5>
        </div>
        <div class="card-body">
            <div v-if="jobs.length === 0" class="alert alert-info text-center">
                Нет активных или завершенных задач. Запустите новую задачу выше.
            </div>
            <ul class="list-group">
                <li v-for="job in sortedJobs" :key="job.job_id" class="list-group-item d-flex flex-column mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ID Задачи:</strong> {{ job.job_id }} <br>
                            <strong>Тип атаки:</strong> {{ formatAttackType(job.attack_type) }} <br>
                            <strong>Статус:</strong>
                            <span :class="['badge', getStatusBadgeClass(job.status)]">{{ formatJobStatus(job.status) }}</span>
                            <span v-if="job.status === 'running'" class="spinner-border spinner-border-sm ms-2 text-primary" role="status" aria-hidden="true"></span>
                        </div>
                        <button v-if="job.status === 'pending' || job.status === 'running' || job.status === 'failed'"
                                @click="cancelJob(job.job_id)"
                                class="btn btn-sm btn-outline-danger"
                                title="Отменить задачу">
                            Отменить
                        </button>
                    </div>
                    <div v-if="job.status === 'running' && job.progress !== null && job.progress !== undefined" class="mt-2">
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar" :style="{ width: job.progress + '%' }" :aria-valuenow="job.progress" aria-valuemin="0" aria-valuemax="100">
                                {{ parseFloat(job.progress).toFixed(2) }}%
                            </div>
                        </div>
                        <small class="text-muted mt-1 d-block">Последняя проверенная комбинация: {{ job.last_checked_combination || 'N/A' }}</small>
                    </div>
                    <div v-if="job.status === 'completed' && job.results_json" class="mt-2">
                        <h6>Найденные пароли:</h6>
                        <ul class="list-group list-group-flush">
                            <li v-for="(password, userId) in JSON.parse(job.results_json)[job.attack_type]" :key="userId" class="list-group-item list-group-item-success d-flex justify-content-between align-items-center">
                                <span>User ID: <strong>{{ userId }}</strong></span>
                                <span>Пароль: <strong>{{ password }}</strong></span>
                            </li>
                        </ul>
                    </div>
                    <div v-if="job.status === 'failed' || job.status === 'failed_permanently'" class="mt-2 text-danger">
                        <strong>Ошибка:</strong> {{ job.error_message || 'Неизвестная ошибка.' }}
                        <small v-if="job.retry_count > 0" class="d-block">Попыток: {{ job.retry_count }}</small>
                    </div>
                    <small class="text-muted mt-2">
                        Создано: {{ new Date(job.created_at + ' UTC').toLocaleString() }} |
                        Обновлено: {{ new Date(job.updated_at + ' UTC').toLocaleString() }}
                    </small>
                </li>
            </ul>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.7/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

<script>
    const app = Vue.createApp({
        data() {
            return {
                selectedAttackType: 'easy_numbers', // Значение по умолчанию
                loading: false,
                message: '',
                messageType: '',
                jobs: [] // Список задач, загруженных с сервера
            };
        },
        computed: {
            // Сортировка задач: сначала 'running', 'pending', 'failed', затем 'completed'
            sortedJobs() {
                const statusOrder = {
                    'running': 1,
                    'pending': 2,
                    'failed': 3,
                    'failed_permanently': 4,
                    'completed': 5
                };
                return [...this.jobs].sort((a, b) => {
                    const orderA = statusOrder[a.status] || 99;
                    const orderB = statusOrder[b.status] || 99;
                    if (orderA !== orderB) {
                        return orderA - orderB;
                    }
                    // Если статусы одинаковые, сортируем по дате создания (новые сверху)
                    return new Date(b.created_at).getTime() - new Date(a.created_at).getTime();
                });
            }
        },
        methods: {
            // Метод для запуска новой задачи по взлому
            async startCrackingJob() {
                this.loading = true;
                this.message = '';
                this.messageType = '';

                try {
                    // Используем window.location.origin для формирования абсолютного URL
                    const response = await fetch(`${window.location.origin}/index.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ attackType: this.selectedAttackType })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        this.message = data.message;
                        this.messageType = 'success';
                        this.fetchJobs(); // Обновить список задач после успешного запуска
                    } else {
                        this.message = data.message || 'Неизвестная ошибка при запуске задачи.';
                        this.messageType = 'danger';
                    }
                } catch (error) {
                    console.error('Ошибка при запуске задачи:', error);
                    this.message = 'Произошла ошибка сети или сервера.';
                    this.messageType = 'danger';
                } finally {
                    this.loading = false;
                }
            },

            // Метод для отмены задачи
            async cancelJob(jobId) {
                // Заменяем confirm на alert, так как confirm() не рекомендуется в iframe
                if (!confirm(`Вы уверены, что хотите отменить задачу ID ${jobId}?`)) {
                    return;
                }

                try {
                    // Используем window.location.origin для формирования абсолютного URL
                    const response = await fetch(`${window.location.origin}/cancel.php`, { // Предполагаем, что у вас будет endpoint cancel.php
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ job_id: jobId })
                    });

                    const data = await response.json();

                    if (data.status === 'success') {
                        // Заменяем alert на console.log или кастомное сообщение в UI
                        console.log(data.message);
                        this.message = data.message;
                        this.messageType = 'success';
                        this.fetchJobs(); // Обновить список задач
                    } else {
                        // Заменяем alert на console.log или кастомное сообщение в UI
                        console.error(data.message || 'Не удалось отменить задачу.');
                        this.message = data.message || 'Не удалось отменить задачу.';
                        this.messageType = 'danger';
                    }
                } catch (error) {
                    console.error('Ошибка при отмене задачи:', error);
                    this.message = 'Произошла ошибка при отмене задачи.';
                    this.messageType = 'danger';
                }
            },

            // Метод для получения списка всех задач
            async fetchJobs() {
                try {
                    // Используем window.location.origin для формирования абсолютного URL
                    const response = await fetch(`${window.location.origin}/jobs.php`); // Предполагаем, что у вас будет endpoint jobs.php
                    const data = await response.json();

                    if (data.status === 'success') {
                        this.jobs = data.jobs;
                    } else {
                        console.error('Ошибка при получении списка задач:', data.message);
                        this.jobs = [];
                    }
                } catch (error) {
                    console.error('Ошибка сети при получении списка задач:', error);
                    this.jobs = [];
                }
            },

            // Вспомогательная функция для форматирования типа атаки
            formatAttackType(type) {
                switch (type) {
                    case 'easy_numbers': return 'Легкие числа (5 цифр)';
                    case 'medium_dict': return 'Средний (словарь)';
                    case 'medium_alpha_num': return 'Средний (3 загл. + 1 цифра)';
                    case 'hard_mixed': return 'Сложный (смешанный)';
                    default: return type;
                }
            },
            // Вспомогательная функция для форматирования статуса задачи
            formatJobStatus(status) {
                switch (status) {
                    case 'pending': return 'В ожидании';
                    case 'running': return 'Выполняется';
                    case 'completed': return 'Завершено';
                    case 'failed': return 'Сбой (повтор)';
                    case 'failed_permanently': return 'Сбой (окончательно)';
                    default: return status;
                }
            },
            // Вспомогательная функция для получения класса Bootstrap для статуса
            getStatusBadgeClass(status) {
                switch (status) {
                    case 'pending': return 'bg-warning';
                    case 'running': return 'bg-info';
                    case 'completed': return 'bg-success';
                    case 'failed': return 'bg-danger';
                    case 'failed_permanently': return 'bg-dark';
                    default: return 'bg-secondary';
                }
            }
        },
        mounted() {
            this.fetchJobs(); // Загружаем задачи при монтировании компонента
            // Обновляем задачи каждые 5 секунд
            setInterval(this.fetchJobs, 5000);
        }
    });

    app.mount('#app');
</script>
</body>
</html>
